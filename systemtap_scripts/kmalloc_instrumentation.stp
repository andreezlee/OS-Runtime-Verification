%{
	#include <linux/kernel.h>
	#include <linux/init.h>
	#include <linux/module.h>
	#include <linux/syscalls.h>
	#include <linux/file.h>
	#include <linux/fs.h>
	#include <linux/fcntl.h>
	#include <asm/uaccess.h> 
%}

probe timer.ms(5000) { exit () }

probe kernel.function("__kmalloc").return { 
	if (execname()=="kmalloc_app"){
		write("kmalloc ")
		write(bytes_to_string($return))
		write("\n")
	}
	print(execname())
	print("\n")
}

probe kernel.function("kfree") {
	if (execname()=="kmalloc_app"){
		write("kfree ")
		write(bytes_to_string($x))
		write("\n")
	}
}

function write:long (s:string) %{
	struct file *file;
	loff_t pos = 0;
	mm_segment_t old_fs = get_fs();
	set_fs(KERNEL_DS);
	file = filp_open("kmalloc.txt", O_WRONLY|O_CREAT, 0644);
	if (file >= 0) {
		if (file) {
			vfs_write(file, STAP_ARG_s, strlen(STAP_ARG_s), &pos);
		}
		filp_close(file,NULL);
 	}
	set_fs(old_fs);
	STAP_RETURN(0);
%}