%{
	#include <linux/kernel.h>
	#include <linux/init.h>
	#include <linux/module.h>
	#include <linux/syscalls.h>
	#include <linux/file.h>
	#include <linux/fs.h>
	#include <linux/fcntl.h>
	#include <asm/uaccess.h> 
%}

global trace = ""

probe kernel.function("__kmalloc").return { 
	if (execname()=="kmalloc_app"){
		trace = trace."kmalloc @ ".bytes_to_string($return)."\n"
	}
}

probe kernel.function("kfree") {
	if (execname()=="kmalloc_app"){
		trace = trace."kfree @ ".bytes_to_string($x)."\n"
	}
}

# Exit after 10 seconds
probe timer.ms(10000) { exit () }

probe end {
	write(trace)
}

function write:long (s:string) %{
	struct file *file;
	loff_t pos = 0;
	mm_segment_t old_fs = get_fs();
	set_fs(KERNEL_DS);
	file = filp_open("kmalloc.txt", O_WRONLY|O_CREAT, 0644);
	if (file >= 0) {
		if (file) {
			vfs_write(file, STAP_ARG_s, strlen(STAP_ARG_s), &pos);
		}
		filp_close(file,NULL);
 	}
	set_fs(old_fs);
	STAP_RETURN(0);
%}